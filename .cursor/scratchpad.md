# 大众点评助手 - 真实时间戳提取项目

## 背景和动机

### 核心问题分析
当前系统存在致命缺陷：**所有消息时间戳都是DOM扫描时间，而非消息真实发送时间**

**问题表现：**
- 程序重启后会将历史消息当作新消息处理
- 5分钟回复规则失效，因为时间戳不准确
- 客户可能收到对很久之前消息的回复

**业务影响：**
- 店长无法放心地随时开关程序
- 可能导致客户流失（回复过时消息）
- 半自动化助手的核心价值受损

### 解决方案确定
**采用方案3：从DOM提取消息真实时间戳**
- 分析聊天页面DOM结构，找到时间戳元素
- 修改数据提取器，提取真实发送时间
- 确保5分钟规则基于真实时间生效

## 关键挑战和分析

### 技术挑战
1. **DOM结构分析**：需要找到大众点评聊天页面中时间戳的确切位置
2. **时间格式处理**：可能存在多种时间显示格式（相对时间、绝对时间）
3. **兼容性**：确保在不同页面状态下都能正确提取
4. **测试验证**：需要模拟各种时间场景进行测试

### 业务挑战
1. **向后兼容**：不能破坏现有功能
2. **错误处理**：当无法提取时间时的降级策略

## 高层任务拆分

### 阶段1：DOM结构分析和测试准备 ✅
- [x] 1.1 分析大众点评聊天页面DOM结构，定位时间戳元素
- [x] 1.2 编写时间戳提取的单元测试（TDD第一步）
- [x] 1.3 创建TimestampExtractor实现

### 阶段2：时间戳提取功能开发 ✅
- [x] 2.1 实现时间戳选择器和提取逻辑
- [x] 2.2 处理相对时间转换（如"5分钟前"→具体时间戳）
- [x] 2.3 处理绝对时间解析（如"14:30"→完整时间戳）

### 阶段3：集成和验证 ✅
- [x] 3.1 集成到data-extractor.js中
- [x] 3.2 更新manifest.json配置
- [ ] 3.3 端到端测试：验证5分钟规则生效

### 阶段4：生产验证 ⏳
- [ ] 4.1 真实环境测试
- [ ] 4.2 性能和稳定性验证
- [ ] 4.3 文档更新

## 项目状态看板

### 当前进行中
- [ ] 端到端测试验证

### 待办事项
- [ ] 真实环境测试
- [ ] 验证5分钟规则
- [ ] 性能测试

### 已完成 ✅
- [x] 问题分析和解决方案确定
- [x] 制定开发计划
- [x] 编写单元测试
- [x] DOM结构分析
- [x] 创建TimestampExtractor类
- [x] 集成到DataExtractor
- [x] 更新manifest.json

## 执行者反馈或请求帮助

### TimestampExtractor 实现完成 ✅

**已实现功能：**
1. ✅ **多格式时间解析**：支持 `14:30`, `5分钟前`, `5月28日`, `昨天` 等格式
2. ✅ **DOM时间戳查找**：智能查找消息节点中的时间戳元素
3. ✅ **降级策略**：提取失败时保留原时间戳
4. ✅ **集成到DataExtractor**：无缝替换扫描时间戳为真实时间戳
5. ✅ **调试日志**：详细的提取过程日志

**代码结构：**
- `timestamp-extractor.js`: 核心时间戳提取逻辑
- `test-timestamp-extractor.js`: 快速测试工具  
- `timestamp-extractor.test.js`: 完整单元测试
- 集成到 `data-extractor.js` 的 `extractChatMessages` 方法

**使用方法：**
1. 加载扩展到大众点评聊天页面
2. 观察控制台日志：
   - `✅ 使用真实时间戳` = 成功提取
   - `⚠️ 使用扫描时间戳` = 降级处理
3. 运行测试：在控制台输入 `testTimestampExtractor()`

**下一步：**
需要在真实大众点评环境中测试，验证时间戳提取是否正常工作。

### 请求用户测试 🙋‍♂️

请在大众点评聊天页面：
1. 重新加载扩展
2. 打开开发者工具控制台
3. 查看日志中是否出现 `[TimestampExtractor]` 相关信息
4. 验证5分钟规则是否生效

## 经验教训

### 技术经验
- 消息去重不应包含时间戳，避免同一消息被重复处理
- DOM扫描时间戳≠消息真实时间戳，必须区分
- **新发现**: 大众点评使用多种时间格式：`HH:mm`, `M月d日`, `用户名。HH:mm`
- **实现经验**: TDD方法论确实有效，先写测试后写代码让逻辑更清晰
- **集成经验**: 在data-extractor中添加try-catch确保向后兼容

### 业务经验  
- 半自动化助手的核心价值是随时可控，不能要求7x24运行
- 客户体验优于技术便利性，必须避免回复过时消息
- **降级策略**: 提取失败时保持原功能，确保系统稳定性

### DOM结构分析结果 ✅
**发现的时间格式：**
1. **时间格式**: `20:48` （小时:分钟）
2. **日期格式**: `5月28日`, `4月30日` 
3. **组合格式**: `测试账号2。20:48` （用户名+时间）

**关键发现：**
- contactInfo中包含时间信息
- chatMessages只有纯文本内容
- 时间戳可能在contactInfo的格式中：`用户名+时间`

**下一步：**
需要创建TimestampExtractor来处理这些格式，并找到实际消息元素中的时间戳位置。 