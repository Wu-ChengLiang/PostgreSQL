<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端功能测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { margin: 5px; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>名医堂3.0 前端功能测试</h1>
    
    <div class="test-section">
        <h2>API测试</h2>
        <button onclick="testAllAPIs()">运行所有API测试</button>
        <div id="api-results"></div>
    </div>
    
    <div class="test-section">
        <h2>界面功能测试</h2>
        <button onclick="testUIComponents()">测试UI组件</button>
        <div id="ui-results"></div>
    </div>
    
    <div class="test-section">
        <h2>实时测试</h2>
        <button onclick="window.open('/', '_blank')">打开客户端</button>
        <button onclick="window.open('/admin.html', '_blank')">打开管理端</button>
    </div>

    <script>
        const API_BASE = '/api/v1/client';
        const ADMIN_API_BASE = '/api/v1/admin';
        
        async function testAllAPIs() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<h3>测试中...</h3>';
            
            let html = '';
            
            // 1. 健康检查
            try {
                const healthRes = await fetch('/health');
                const healthData = await healthRes.json();
                html += `<div class="success">✅ 健康检查: ${healthData.service}</div>`;
            } catch (e) {
                html += `<div class="error">❌ 健康检查失败: ${e.message}</div>`;
            }
            
            // 2. 缓存状态
            try {
                const cacheRes = await fetch('/cache/stats');
                const cacheData = await cacheRes.json();
                html += `<div class="success">✅ 缓存状态: 命中率 ${cacheData.stats.hitRate}</div>`;
            } catch (e) {
                html += `<div class="error">❌ 缓存状态失败: ${e.message}</div>`;
            }
            
            // 3. 门店列表
            try {
                const storesRes = await fetch(`${API_BASE}/stores`);
                const storesData = await storesRes.json();
                const storeCount = storesData.data.stores.length;
                html += `<div class="success">✅ 门店列表: ${storeCount} 家门店</div>`;
                
                // 测试第一家门店的详情
                if (storeCount > 0) {
                    const firstStore = storesData.data.stores[0];
                    const storeDetailRes = await fetch(`${API_BASE}/stores/${firstStore.id}`);
                    const storeDetail = await storeDetailRes.json();
                    html += `<div class="info">  - ${firstStore.name}: ${storeDetail.data.therapists.length} 位技师</div>`;
                    
                    // 测试门店技师排班
                    const encodedName = encodeURIComponent(firstStore.name);
                    const scheduleRes = await fetch(`${API_BASE}/stores/${encodedName}/therapists-schedule`);
                    const scheduleData = await scheduleRes.json();
                    if (scheduleRes.ok) {
                        html += `<div class="success">✅ 门店技师排班API: ${scheduleData.data.therapists.length} 位技师</div>`;
                    }
                }
            } catch (e) {
                html += `<div class="error">❌ 门店API失败: ${e.message}</div>`;
            }
            
            // 4. 技师搜索
            try {
                const therapistsRes = await fetch(`${API_BASE}/therapists/search?limit=10`);
                const therapistsData = await therapistsRes.json();
                const total = therapistsData.data.total || therapistsData.data.therapists.length;
                html += `<div class="success">✅ 技师搜索: ${therapistsData.data.therapists.length} 位技师 (总计: ${total})</div>`;
            } catch (e) {
                html += `<div class="error">❌ 技师搜索失败: ${e.message}</div>`;
            }
            
            // 5. 管理端登录
            try {
                const loginRes = await fetch(`${ADMIN_API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                const loginData = await loginRes.json();
                
                if (loginData.success) {
                    html += `<div class="success">✅ 管理端登录成功</div>`;
                    const token = loginData.data.token;
                    
                    // 测试管理端API
                    const headers = { 'Authorization': `Bearer ${token}` };
                    
                    const adminStoresRes = await fetch(`${ADMIN_API_BASE}/stores`, { headers });
                    const adminStoresData = await adminStoresRes.json();
                    html += `<div class="info">  - 管理端门店: ${adminStoresData.data.stores.length} 家</div>`;
                    
                    const adminTherapistsRes = await fetch(`${ADMIN_API_BASE}/therapists`, { headers });
                    const adminTherapistsData = await adminTherapistsRes.json();
                    html += `<div class="info">  - 管理端技师: ${adminTherapistsData.data.total} 位</div>`;
                } else {
                    html += `<div class="error">❌ 管理端登录失败</div>`;
                }
            } catch (e) {
                html += `<div class="error">❌ 管理端API失败: ${e.message}</div>`;
            }
            
            resultsDiv.innerHTML = '<h3>API测试结果</h3>' + html;
        }
        
        async function testUIComponents() {
            const resultsDiv = document.getElementById('ui-results');
            resultsDiv.innerHTML = '<h3>测试中...</h3>';
            
            let html = '';
            
            // 获取客户端页面
            try {
                const pageRes = await fetch('/');
                const pageHtml = await pageRes.text();
                
                // 检查关键元素
                const components = [
                    { id: 'storeSelect', name: '门店选择' },
                    { id: 'therapistStoreFilter', name: '技师筛选' },
                    { id: 'appointmentStore', name: '预约门店' },
                    { id: 'appointmentDate', name: '预约日期' },
                    { id: 'appointmentTherapist', name: '预约技师' }
                ];
                
                html += '<h4>客户端组件检查：</h4>';
                components.forEach(comp => {
                    if (pageHtml.includes(`id="${comp.id}"`)) {
                        html += `<div class="success">✅ ${comp.name}</div>`;
                    } else {
                        html += `<div class="error">❌ ${comp.name} 缺失</div>`;
                    }
                });
                
                // 检查JavaScript函数
                const functions = ['showStores', 'showTherapists', 'showAppointment', 'loadStores'];
                html += '<h4>JavaScript函数检查：</h4>';
                functions.forEach(func => {
                    if (pageHtml.includes(func)) {
                        html += `<div class="success">✅ ${func}()</div>`;
                    } else {
                        html += `<div class="error">❌ ${func}() 缺失</div>`;
                    }
                });
                
            } catch (e) {
                html += `<div class="error">❌ UI测试失败: ${e.message}</div>`;
            }
            
            resultsDiv.innerHTML = '<h3>UI测试结果</h3>' + html;
        }
        
        // 页面加载后自动运行测试
        window.onload = () => {
            console.log('准备运行测试...');
        };
    </script>
</body>
</html>