# 🔧 服务器IPv4配置修复指南

## 🎯 问题分析
服务器目前只监听IPv6地址（`::1`），需要配置为监听IPv4地址。

## 🔍 当前状态
- ❌ IPv4: `127.0.0.1:3000` - 连接被拒绝
- ✅ IPv6: `[::1]:3000` - 正常工作
- 🌐 浏览器: 正常工作（因为浏览器会自动尝试IPv6）

## 💡 解决方案

### 方案1：修改服务器监听地址（推荐）

找到您的服务器启动文件（通常是 `src/app.js` 或 `server.js`），修改监听配置：

#### 当前配置可能是：
```javascript
// 错误的配置 - 只监听IPv6
app.listen(3000, () => {
    console.log('服务器运行在端口 3000');
});

// 或者
app.listen(3000, '::1', () => {
    console.log('服务器运行在 IPv6');
});
```

#### 正确配置应该是：
```javascript
// 方案A: 监听所有地址（IPv4 + IPv6）
app.listen(3000, '0.0.0.0', () => {
    console.log('服务器运行在端口 3000 (所有地址)');
});

// 方案B: 只监听IPv4
app.listen(3000, '127.0.0.1', () => {
    console.log('服务器运行在 127.0.0.1:3000');
});

// 方案C: 不指定地址，让系统决定
app.listen(3000, () => {
    console.log('服务器运行在端口 3000');
});
```

### 方案2：环境变量配置

如果使用环境变量，请检查：

```bash
# 检查当前环境变量
echo $HOST
echo $PORT

# 设置正确的环境变量
export HOST=0.0.0.0
export PORT=3000
```

### 方案3：package.json 启动脚本

检查 `package.json` 中的启动脚本：

```json
{
  "scripts": {
    "start": "node src/app.js",
    "dev": "nodemon src/app.js"
  }
}
```

如果使用 nodemon 或其他工具，确保没有指定IPv6：

```json
{
  "scripts": {
    "start": "node src/app.js --host 0.0.0.0",
    "dev": "nodemon src/app.js --host 0.0.0.0"
  }
}
```

## 🔍 如何检查服务器配置

### 方法1：查看服务器启动日志
```bash
node src/app.js
```
查看启动信息，应该显示监听的地址。

### 方法2：使用netstat检查端口
```bash
# Windows
netstat -an | findstr :3000

# 期望看到：
# 0.0.0.0:3000      而不是 [::1]:3000
```

### 方法3：测试连接
```bash
# 测试IPv4连接
curl http://127.0.0.1:3000

# 测试IPv6连接
curl http://[::1]:3000
```

## 📝 修改步骤

1. **找到服务器启动文件**
   ```bash
   # 常见位置
   src/app.js
   src/server.js
   index.js
   server.js
   ```

2. **修改监听配置**
   ```javascript
   // 将这样的代码
   app.listen(3000);
   
   // 改为
   app.listen(3000, '0.0.0.0', () => {
       console.log('服务器运行在 http://0.0.0.0:3000');
   });
   ```

3. **重启服务器**
   ```bash
   # 停止当前服务器 (Ctrl+C)
   # 重新启动
   npm start
   # 或
   node src/app.js
   ```

4. **验证修复**
   ```bash
   # 运行修复后的测试脚本
   node test_api_connection_fixed.js
   ```

## ✅ 修复后的期望结果

测试脚本应该显示：
```
🔍 检查服务器连接...
   尝试连接: http://127.0.0.1:3000
✅ 服务器连接成功: 200 (http://127.0.0.1:3000)
```

而不是：
```
   尝试连接: http://127.0.0.1:3000
❌ http://127.0.0.1:3000 连接失败: ECONNREFUSED
   尝试连接: http://[::1]:3000
✅ 服务器连接成功: 200 (http://[::1]:3000)
⚠️ 注意: 服务器运行在IPv6上，建议配置为IPv4
```

## 🚨 常见问题

### Q: 为什么浏览器能访问但测试脚本不能？
A: 浏览器会自动尝试IPv6，而默认的Node.js HTTP客户端优先使用IPv4。

### Q: 应该使用 0.0.0.0 还是 127.0.0.1？
A: 
- `0.0.0.0` - 监听所有网络接口，可以从其他机器访问
- `127.0.0.1` - 只监听本地回环，只能本机访问
- 开发环境建议使用 `0.0.0.0`

### Q: 修改后仍然连接失败？
A: 
1. 确认没有其他程序占用3000端口
2. 检查防火墙设置
3. 尝试重启电脑（清除网络缓存）

## 🎉 完成后

修复服务器配置后，所有API测试脚本都应该正常工作！ 