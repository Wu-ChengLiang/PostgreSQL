<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ä¼—ç‚¹è¯„æ‰©å±•é‡æ„æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .mock-element {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¤§ä¼—ç‚¹è¯„æ‰©å±•é‡æ„æµ‹è¯•é¡µé¢</h1>
        
        <div class="section">
            <h3>1. æ¨¡å—åŠ è½½æµ‹è¯•</h3>
            <div id="moduleLoadResults"></div>
            <button onclick="testModuleLoading()">æµ‹è¯•æ¨¡å—åŠ è½½</button>
        </div>

        <div class="section">
            <h3>2. MemoryManager åŠŸèƒ½æµ‹è¯•</h3>
            <div id="memoryResults"></div>
            <button onclick="testMemoryManager()">æµ‹è¯•è®°å¿†ç®¡ç†</button>
        </div>

        <div class="section">
            <h3>3. DianpingExtractor åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
            <div id="extractorResults"></div>
            <button onclick="testDianpingExtractor()">æµ‹è¯•æ•°æ®æå–å™¨</button>
        </div>

        <div class="section">
            <h3>4. é›†æˆæµ‹è¯•</h3>
            <div id="integrationResults"></div>
            <button onclick="testIntegration()">æµ‹è¯•é›†æˆåŠŸèƒ½</button>
        </div>

        <!-- æ¨¡æ‹Ÿå¤§ä¼—ç‚¹è¯„é¡µé¢å…ƒç´  -->
        <div class="mock-element">
            <div class="userinfo-username" data-chatid="test123">æµ‹è¯•ç”¨æˆ·</div>
            <div class="userinfo-from-shop">ä¸Šæµ· - ååŒ»å ‚Â·é¢ˆè‚©è…°è…¿ç‰¹è‰²è°ƒç†ï¼ˆå…°æºªè·¯åº—ï¼‰</div>
            <div class="text-message normal-text">è¿™æ˜¯ä¸€æ¡å®¢æˆ·æ¶ˆæ¯</div>
            <div class="text-message shop-text">è¿™æ˜¯ä¸€æ¡å•†å®¶å›å¤</div>
            <div class="tuan">
                <div class="tuan-name">æµ‹è¯•å›¢è´­</div>
                <div class="sale-price">Â¥99</div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é‡æ„åçš„æ¨¡å— -->
    <script src="dianping-scraper/extension/memory.js"></script>
    <script>
        // æ¨¡æ‹ŸChromeæ‰©å±•API
        window.chrome = {
            runtime: {
                sendMessage: function(message, callback) {
                    console.log('æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯:', message);
                    if (callback) callback({ status: 'success' });
                },
                onMessage: {
                    addListener: function(listener) {
                        console.log('æ¨¡æ‹Ÿæ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨');
                    }
                },
                getURL: function(path) {
                    return '/mock/' + path;
                }
            }
        };

        // æµ‹è¯•ç»“æœæ˜¾ç¤ºå‡½æ•°
        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // 1. æµ‹è¯•æ¨¡å—åŠ è½½
        function testModuleLoading() {
            clearResults('moduleLoadResults');
            
            try {
                // æµ‹è¯•MemoryManageræ˜¯å¦å¯ç”¨
                if (typeof MemoryManager !== 'undefined') {
                    showResult('moduleLoadResults', 'âœ… MemoryManager æ¨¡å—åŠ è½½æˆåŠŸ', 'success');
                } else {
                    showResult('moduleLoadResults', 'âŒ MemoryManager æ¨¡å—æœªæ‰¾åˆ°', 'error');
                }

                // æµ‹è¯•æ˜¯å¦èƒ½åˆ›å»ºMemoryManagerå®ä¾‹
                const memoryManager = new MemoryManager();
                if (memoryManager) {
                    showResult('moduleLoadResults', 'âœ… MemoryManager å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                } else {
                    showResult('moduleLoadResults', 'âŒ MemoryManager å®ä¾‹åˆ›å»ºå¤±è´¥', 'error');
                }

            } catch (error) {
                showResult('moduleLoadResults', `âŒ æ¨¡å—åŠ è½½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 2. æµ‹è¯•MemoryManageråŠŸèƒ½
        function testMemoryManager() {
            clearResults('memoryResults');
            
            try {
                const memoryManager = new MemoryManager();
                
                // æµ‹è¯•åŸºæœ¬å±æ€§
                const initialStatus = memoryManager.getMemoryStatus();
                showResult('memoryResults', `âœ… åˆå§‹çŠ¶æ€è·å–æˆåŠŸ: ${JSON.stringify(initialStatus)}`, 'success');
                
                // æµ‹è¯•è”ç³»äººä¿¡æ¯æ›´æ–°
                memoryManager.updateContactInfo('test123', 'æµ‹è¯•ç”¨æˆ·', 'æµ‹è¯•åº—é“º');
                const updatedStatus = memoryManager.getMemoryStatus();
                showResult('memoryResults', `âœ… è”ç³»äººä¿¡æ¯æ›´æ–°æˆåŠŸ: ${updatedStatus.combinedContactName}`, 'success');
                
                // æµ‹è¯•è®°å¿†æ·»åŠ 
                const testMessage = {
                    id: 'test_msg_1',
                    messageType: 'customer',
                    originalContent: 'æµ‹è¯•æ¶ˆæ¯å†…å®¹',
                    timestamp: Date.now()
                };
                
                memoryManager.addToMemoryWithoutTrigger(testMessage);
                const memorySnapshot = memoryManager.getMemorySnapshot();
                showResult('memoryResults', `âœ… è®°å¿†æ·»åŠ æˆåŠŸ: å½“å‰è®°å¿†æ•°é‡ ${memorySnapshot.length}`, 'success');
                
                // æµ‹è¯•è®°å¿†æ¸…ç©º
                memoryManager.clearMemory();
                const clearedSnapshot = memoryManager.getMemorySnapshot();
                showResult('memoryResults', `âœ… è®°å¿†æ¸…ç©ºæˆåŠŸ: å½“å‰è®°å¿†æ•°é‡ ${clearedSnapshot.length}`, 'success');
                
            } catch (error) {
                showResult('memoryResults', `âŒ MemoryManager æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 3. æµ‹è¯•DianpingExtractoråŸºç¡€åŠŸèƒ½ï¼ˆæ¨¡æ‹Ÿï¼‰
        function testDianpingExtractor() {
            clearResults('extractorResults');
            
            try {
                // æ¨¡æ‹Ÿåˆ›å»ºDianpingExtractorï¼ˆç®€åŒ–ç‰ˆï¼‰
                const mockExtractor = {
                    memoryManager: new MemoryManager(),
                    formatShopName: function(rawName) {
                        if (!rawName) return null;
                        let formattedName = rawName.replace(/^.+?\s*-\s*/, '');
                        formattedName = formattedName.replace(/\(/g, 'ï¼ˆ').replace(/\)/g, 'ï¼‰');
                        return formattedName.trim();
                    },
                    detectPageType: function() {
                        return 'chat_page';
                    }
                };
                
                showResult('extractorResults', 'âœ… æ¨¡æ‹Ÿæ•°æ®æå–å™¨åˆ›å»ºæˆåŠŸ', 'success');
                
                // æµ‹è¯•åº—é“ºåç§°æ ¼å¼åŒ–
                const testShopName = 'ä¸Šæµ· - ååŒ»å ‚Â·é¢ˆè‚©è…°è…¿ç‰¹è‰²è°ƒç†ï¼ˆå…°æºªè·¯åº—ï¼‰';
                const formattedName = mockExtractor.formatShopName(testShopName);
                showResult('extractorResults', `âœ… åº—é“ºåç§°æ ¼å¼åŒ–: "${formattedName}"`, 'success');
                
                // æµ‹è¯•é¡µé¢ç±»å‹æ£€æµ‹
                const pageType = mockExtractor.detectPageType();
                showResult('extractorResults', `âœ… é¡µé¢ç±»å‹æ£€æµ‹: ${pageType}`, 'success');
                
            } catch (error) {
                showResult('extractorResults', `âŒ DianpingExtractor æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 4. æµ‹è¯•é›†æˆåŠŸèƒ½
        function testIntegration() {
            clearResults('integrationResults');
            
            try {
                const memoryManager = new MemoryManager();
                
                // æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµç¨‹
                showResult('integrationResults', 'ğŸ”„ å¼€å§‹é›†æˆæµ‹è¯•...', 'info');
                
                // 1. åˆå§‹åŒ–è”ç³»äºº
                memoryManager.updateContactInfo('chat123', 'æµ‹è¯•è”ç³»äºº', 'æµ‹è¯•åº—é“º');
                showResult('integrationResults', 'âœ… æ­¥éª¤1: è”ç³»äººåˆå§‹åŒ–å®Œæˆ', 'success');
                
                // 2. æ·»åŠ å¤šæ¡æ¶ˆæ¯åˆ°è®°å¿†
                const messages = [
                    { id: 'msg1', messageType: 'customer', originalContent: 'ä½ å¥½', timestamp: Date.now() },
                    { id: 'msg2', messageType: 'shop', originalContent: 'æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ', timestamp: Date.now() + 1000 },
                    { id: 'msg3', messageType: 'customer', originalContent: 'æˆ‘æƒ³é¢„çº¦æŒ‰æ‘©', timestamp: Date.now() + 2000 }
                ];
                
                messages.forEach(msg => {
                    memoryManager.addToMemoryWithoutTrigger(msg);
                });
                showResult('integrationResults', 'âœ… æ­¥éª¤2: å¤šæ¡æ¶ˆæ¯æ·»åŠ å®Œæˆ', 'success');
                
                // 3. æ£€æŸ¥è®°å¿†çŠ¶æ€
                const finalStatus = memoryManager.getMemoryStatus();
                showResult('integrationResults', `âœ… æ­¥éª¤3: æœ€ç»ˆçŠ¶æ€æ£€æŸ¥ - è®°å¿†æ•°é‡: ${finalStatus.memoryCount}, è”ç³»äºº: ${finalStatus.combinedContactName}`, 'success');
                
                // 4. æµ‹è¯•è”ç³»äººåˆ‡æ¢
                const newContactInfo = {
                    name: 'æ–°è”ç³»äºº',
                    chatId: 'new_chat_456',
                    shopName: 'æ–°åº—é“º'
                };
                
                memoryManager.handleContactSwitch(newContactInfo);
                const switchedStatus = memoryManager.getMemoryStatus();
                showResult('integrationResults', `âœ… æ­¥éª¤4: è”ç³»äººåˆ‡æ¢å®Œæˆ - æ–°è”ç³»äºº: ${switchedStatus.combinedContactName}`, 'success');
                
                showResult('integrationResults', 'ğŸ‰ é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');
                
            } catch (error) {
                showResult('integrationResults', `âŒ é›†æˆæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºæœ¬æµ‹è¯•
        window.addEventListener('load', function() {
            setTimeout(() => {
                testModuleLoading();
            }, 500);
        });
    </script>
</body>
</html> 